<?php
use Drupal\webform\Utility\WebformFormHelper;

/**
 * Implements hook_form_alter().
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function pe_presentation_evaluation_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if ($form_id == 'webform_submission_ped_sace_student_feedback_add_form') {
    $form['#attached']['library'][] = 'pe_presentation_evaluation/pe_presentation_evaluation';
    $form['#attached']['drupalSettings']['pe_presentation_evaluation']['pe_presentation_evaluation']['test'] = 'values';

    //Get webform form elements
    $elements = WebformFormHelper::flattenElements($form);

    // Disable date and presentation method fields
    $elements['civicrm_1_activity_1_activity_activity_date_time']['#disabled'] = TRUE;
    $elements['civicrm_1_activity_1_cg2_custom_88']['#disabled'] = TRUE;

    //Get default selected value for Presentation Topic
    $default_vals = $elements['civicrm_1_activity_1_cg2_custom_40']['#default_value'];
    $topics = [];
    foreach ($default_vals as $val) {
      if ($val == 'CustomSomethingDifferent' && !empty($elements['civicrm_1_activity_1_cg2_custom_340']['#default_value'])) {
        $topics[] = $elements['civicrm_1_activity_1_cg2_custom_340']['#default_value'];
      }
      else {
        $topics[] = $elements['civicrm_1_activity_1_cg2_custom_40']['#options'][$val];
      }
    }
    if (is_array($topics)) {
      $topic = implode(', ', $topics);
    }
    else {
      $topic = $topics;
    }
    $elements['civicrm_1_activity_1_cg2_custom_40']['#access'] = FALSE;
    $elements['presentation_topic_markup']['#markup'] = '<label for="presentation_topic_markup" class="form-item__label">Presentation Topic(s)</label><div>' . $topic . '</div>';
    $elements['civicrm_1_activity_1_cg2_custom_340']['#access'] = FALSE;


    //Update Q1 presentation topic
    //Get q1
    $q1 = $elements["q1"]["#title"];
    //Update text for q1
    $elements['q1']['#title'] = str_replace('the presentation topic', $topic, $q1);

    //Update Q2 presentation topic
    //Get q2
    $q2 = $elements["feedback"]["#title"];
    //Update text for q2
    $elements['feedback']['#title'] = str_replace('the topic', $topic, $q2);

    $q3 = $elements["q3"]["#title"];
    $elements['q3']['#title'] = str_replace('the presentation topic', $topic, $q3);

    $q4 = $elements["feedback_q4"]["#title"];
    //Update text for q4
    $elements['feedback_q4']['#title'] = str_replace('the topic', $topic, $q4);

    $q5 = $elements["q5"]["#title"];
    $elements['q5']['#title'] = str_replace('the presentation topic', $topic, $q5);

    $q6 = $elements["feedback_q6"]["#title"];
    //Update text for q6
    $elements['feedback_q6']['#title'] = str_replace('the topic', $topic, $q6);

    // Get activity id from query var.
    //get from form field TODO
    $aid = $elements['aid']['#default_value'] ?? 0;
    if (empty($aid) || !is_numeric($aid)) {
      return;
    }

    // Get Booking Intake custom fields
    $result = \Civi\Api4\Activity::get()
      ->addSelect('Booking_Information.Support_Content', 'Booking_Information.Presentation_topics', 'Booking_Information.Resources_Content', 'Booking_Information.Safer_Spaces_Content', 'Booking_Information.Facilitating_Program', 'Booking_Information.Presentation_Population_of_Focus', 'Booking_Information.Presentation_Method')
      ->addWhere('id', '=', $aid)
      ->execute()
      ->first();

    if (empty($result)) {
      return;
    }

    // Q3-4 based on support content toggled
    if ($result["Booking_Information.Support_Content"] != 1) {
      $elements['q3']['#access'] = FALSE;
      $elements['feedback_q4']['#access'] = FALSE;
    }

    // Q5 - q6 based on Community Resources or SACE Services toggled
    if ($result["Booking_Information.Resources_Content"] != 1) {
      $elements['q5']['#access'] = FALSE;
      $elements['feedback_q6']['#access'] = FALSE;
    }

    // Q9 - q11 toggle based on Safer Spaces Content toggled
    if ($result['Booking_Information.Safer_Spaces_Content'] != 1) {
      $elements['q9']['#access'] = FALSE;
      $elements['q10']['#access'] = FALSE;
      $elements['q11']['#access'] = FALSE;
    }

    //Q12 toggle based on facilitating program is Institutional Support
    if ($result['Booking_Information.Facilitating_Program'] != 'InstitutionalSupport') {
      $elements['q12']['#access'] = FALSE;
    }

    // Q13-15 toggle based on Demographic   information
    if ($result['Booking_Information.Presentation_Population_of_Focus'] != NULL) {
      $elements['q13']['#access'] = FALSE;
      $elements['q14']['#access'] = FALSE;
      $elements['q15']['#access'] = FALSE;
    }

    //Q16 toggle show when presentation topic is Bystander Intervention
    if ($result['Booking_Information.Presentation_topics'] != 'BystanderIntervention') {
      $elements['q16']['#access'] = FALSE;
    }

    //Q17 toggle show when presentation topic is Privilege and Oppression
    if ($result['Booking_Information.Presentation_topics'] != 'PrivilegeandOppression') {
      $elements['q17']['#access'] = FALSE;
    }

    //Q19-20 update presentation method
    if(empty($result['Booking_Information.Presentation_Method'])) {
      return;
    }
    $form['elements']['q19']['#title'] = str_replace('[INSERT PRESENTATION METHOD]', $result['Booking_Information.Presentation_Method'], $form['elements']['q19']['#title']);
    $form['elements']['q20']['#title'] = str_replace('[INSERT PRESENTATION METHOD]', $result['Booking_Information.Presentation_Method'], $form['elements']['q20']['#title']);
    // exit('<pre>'. print_r($form['elements']['q20']['#title'], TRUE).'</pre>');k

  }
}
