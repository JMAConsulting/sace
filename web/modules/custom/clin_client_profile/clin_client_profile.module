<?php

use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\webform\Utility\WebformFormHelper;
use Drupal\webform\Entity\Webform;
use Drupal\user\Entity\User;
use Drupal\Core\Url;
use Drupal\Core\Database\Database;
use Symfony\Component\HttpFoundation\Request;
use Drupal\Core\Render\BubbleableMetadata;

function clin_client_profile_views_pre_view($view, $display_id, &$args) {
  if ($view->id() == 'client_home' || $view->id() == 'security' || $view->id() == 'clin_flags' || $view->id() == 'appointments'|| $view->id() == 'contact_notes' || $view->id() == 'contact_information') {
    if ($display_id == 'page_1') {
      $current_user = \Drupal::currentUser();
      $current_user_id = \Drupal::currentUser()->id();
      $roles = $current_user->getRoles();
      if(!in_array('clin_director', $roles) && !in_array('wheel', $roles) && !in_array('clin_tl', $roles)) {
        // If logged in user is a counsellor
        if(in_array('clin_counsellor', $roles)) {
          if (_counsellor_deny_access($current_user_id)) {
            \Drupal::messenger()->addError(t('You do not have access to view this client profile.'));
	          $access_result = Drupal\Core\Access\AccessResult::forbidden('You do not have access to this page.');
   	        throw new Drupal\Core\Http\Exception\CacheableAccessDeniedHttpException($access_result, $access_result->getReason());
          }
        }
        elseif(in_array('ce_staff', $roles)) {
          if (_ce_staff_deny_access($current_user_id)) {
            $bubbleable_metadata = new BubbleableMetadata();
            $bubbleable_metadata->addAttachments(['library' => 'clin_client_profile/access_denied']);
            $bubbleable_metadata->applyTo($view->element);
          }
        }
      }
    }
  }
}

function clin_client_profile_preprocess_page(&$variables) {
  $current_path = \Drupal::service('path.current')->getPath();
  $pattern = '/\/contact-information(?:\/[\w-]+)*\/(\d+)/';
  // Add JS to /client-home pages
  if (preg_match($pattern, $current_path, $matches)) {
    $variables['#attached']['library'][] = 'clin_client_profile/clin_client_profile';
  }
  if (preg_match('/\/contact-information\/notes\/(\d+)/', $current_path, $matches)) {
    $variables['#attached']['library'][] = 'clin_client_profile/clin_contact_notes';
  }
}

/**
 * Implements hook_form_alter().
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function clin_client_profile_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if ($form_id == "webform_submission_client_profile_add_form" || $form_id == "webform_submission_add_note_to_appointment_add_form" || 
  $form_id == "webform_submission_add_flag_add_form" ||  $form_id == "webform_submission_remove_flag_add_form") {
    $current_user = \Drupal::currentUser();
    $roles = $current_user->getRoles();
    $current_user_id = \Drupal::currentUser()->id();

    if(!in_array('clin_director', $roles) && !in_array('wheel', $roles) && !in_array('clin_tl', $roles)) {
      // If logged in user is a counsellor
      if(in_array('clin_counsellor', $roles)) {
        if (_counsellor_deny_access($current_user_id)) {
	        $form['#access'] = FALSE;
          if ($form_id == "webform_submission_client_profile_add_form") {
            \Drupal::messenger()->addError(t('You do not have access to view this client.'));
            return;
          }
          elseif ($form_id == "webform_submission_add_flag_add_form") {
            \Drupal::messenger()->addError(t('You do not have access to add or edit flags for this client.'));
          }
          elseif ($form_id == "webform_submission_remove_flag_add_form") {
            \Drupal::messenger()->addError(t('You do not have access to delete flags for this client.'));
          }
          elseif ($form_id == "webform_submission_add_note_to_appointment_add_form") {
            \Drupal::messenger()->addError(t('You do not have access to add notes for this client.'));
          }
          $access_result = Drupal\Core\Access\AccessResult::forbidden('You do not have access to this page.');
          throw new Drupal\Core\Http\Exception\CacheableAccessDeniedHttpException($access_result, $access_result->getReason());
        }
      }
      elseif(in_array('ce_staff', $roles)) {
        if (_ce_staff_deny_access($current_user_id)) {
          if ($form_id == "webform_submission_client_profile_add_form") {
            $form['#prefix'] = '<div class="webform-locked-message">' . t('You do not have access to edit this client.') . '</div>';
            $form['#attributes']['class'][] = 'webform-locked';
            $form['actions']['submit']['#attributes']['disabled'] = 'disabled';
            clin_client_profile_make_form_read_only($form);
          }
          else {
            $form['#access'] = FALSE;
            if ($form_id == "webform_submission_add_flag_add_form") {
              \Drupal::messenger()->addError(t('You do not have access to add or edit flags for this client.'));
            }
            elseif ($form_id == "webform_submission_remove_flag_add_form") {
              \Drupal::messenger()->addError(t('You do not have access to delete flags for this client.'));
            }
            elseif ($form_id == "webform_submission_add_note_to_appointment_add_form") {
              \Drupal::messenger()->addError(t('You do not have access to add notes for this client.'));
            }
            $access_result = Drupal\Core\Access\AccessResult::forbidden('You do not have access to this page.');
            throw new Drupal\Core\Http\Exception\CacheableAccessDeniedHttpException($access_result, $access_result->getReason());
          }
        }
      }
      // Read only if reception or intake
      elseif(in_array('reception', $roles) || in_array('intake', $roles)) {
        if ($form_id == "webform_submission_client_profile_add_form") {
          $form['#prefix'] = '<div class="webform-locked-message">' . t('You do not have access to edit this client.') . '</div>';
          $form['#attributes']['class'][] = 'webform-locked';
          $form['actions']['submit']['#attributes']['disabled'] = 'disabled';
          clin_client_profile_make_form_read_only($form);
        }
        else {
          $form['#access'] = FALSE;
        }
      }
      // Hide form otherwise
      else {
        \Drupal::messenger()->addError(t('You do not have access to view this content.'));
        $form['#access'] = FALSE;
      } 
    }
  }
}

function clin_client_profile_make_form_read_only(&$elements) {
  foreach ($elements as $key => &$element) {
    if (is_array($element)) {
      if (isset($element['#type']) && in_array($element['#type'], ['textfield', 'textarea', 'select', 'checkbox', 'radios', 'checkboxes', 'date', 'email', 'number', 'tel', 'url'])) {
        $element['#attributes']['readonly'] = 'readonly';
        if ($element['#type'] == 'select') {
          $element['#attributes']['disabled'] = 'disabled';
        }
        if ($element['#type'] == 'checkbox' || $element['#type'] == 'radios' || $element['#type'] == 'checkboxes') {
          $element['#disabled'] = TRUE;
        }
      } elseif (!empty($element)) {
        clin_client_profile_make_form_read_only($element);
      }
    }
  }
}

function clin_client_profile_preprocess_menu(&$variables) {
  if ($variables['menu_name'] == 'main') {
    $current_user = \Drupal::currentUser();
    $uid = $current_user->id();

    // Call a recursive function to update the URL of the nested menu item.
    clin_client_profile_update_nested_menu_item($variables['items'], $uid);
  }
}

// Append uid to my-clients view for filtering
function clin_client_profile_update_nested_menu_item(&$items, $uid) {
  foreach ($items as &$item) {
    if (isset($item['url'])) {
      $path = $item['url']->toString();

      // Check if the path is 'my-clients'.
      if ($path == '/my-clients') {
        // Update the URL to include the current user's UID.
        $item['url'] = Url::fromUri('internal:/my-clients/' . $uid);
      }
    }

    // If this is the Search menu link
    if ($path == '/my-clients' && !empty($item['below'])) {
      clin_client_profile_update_nested_menu_item($item['below'], $uid);
    }
  }
}

function _counsellor_deny_access($current_user_id) {
  \Drupal::service('civicrm')->initialize();     
  $civicrm_database = Database::getConnection('default', 'civicrm');
  
  $query = $civicrm_database->select('civicrm_uf_match', 'c')
    ->fields('c', ['contact_id'])
    ->condition('c.uf_id', $current_user_id)
    ->execute();
  
  $result = $query->fetchAssoc();
  
  if ($result) {
    $counsellorID = $result['contact_id'];   
  }
  else {
    return TRUE;
  }

  $path = \Drupal::request()->getRequestUri();

  // Parse the path to extract the CID
  $clientID = 0;

  // Check if CID is in query parameters
  if (preg_match('/[?&]cid(?:2)?=([^&]+)/', $path, $matches)) {
      $clientID = (int) $matches[1];
  } else {
      // If CID is in the path
      $path = strtok($path, '?');
      $path_segments = explode('/', rtrim($path, '/'));
      $last_segment = end($path_segments);
      if (is_numeric($last_segment)) {
          $clientID = (int) $last_segment;
      }
  }

  if ($clientID === 0 && preg_match('/[?&]aid=([^&]+)/', $path, $matches)) {
    $appointmentID = (int) $matches[1];
    $activities = \Civi\Api4\Activity::get(FALSE)
      ->addWhere('id', '=', $appointmentID)
      ->addWhere('assignee_contact_id', '=', $counsellorID)
      ->setLimit(1)
      ->execute();

    if(!count($activities)) {
      return TRUE;
    }
    return FALSE;
  }

  elseif(!$clientID || !$counsellorID) {
    return TRUE;
  }

  $activities = \Civi\Api4\Activity::get(FALSE)
    ->addWhere('assignee_contact_id', '=', $counsellorID)
    ->addWhere('target_contact_id', '=', $clientID)
    ->setLimit(1)
    ->execute();

  // If client is not assigned to logged in counsellor, hide page
  if(!count($activities)) {
    return TRUE;
  }
  return FALSE;
}

function _ce_staff_deny_access($current_user_id) {
  \Drupal::service('civicrm')->initialize();     
  $civicrm_database = Database::getConnection('default', 'civicrm');

  $path = \Drupal::request()->getRequestUri();

  // Parse the path to extract the CID
  $clientID = 0;

  // Check if CID is in query parameters
  if (preg_match('/[?&]cid(?:2)?=([^&]+)/', $path, $matches)) {
      $clientID = (int) $matches[1];
  } else {
    // If CID is in the path
    $path = strtok($path, '?');
    $path_segments = explode('/', rtrim($path, '/'));
    $last_segment = end($path_segments);
    if (is_numeric($last_segment)) {
        $clientID = (int) $last_segment;
    }
  }

  if($clientID) {
    // Get all users assigned to the client
    $activities = \Civi\Api4\Activity::get(FALSE)
      ->addSelect('uf_match.uf_id')
      ->addJoin('UFMatch AS uf_match', 'LEFT', ['assignee_contact_id', '=', 'uf_match.contact_id'])
      ->addWhere('assignee_contact_id', 'IS NOT EMPTY')
      ->addWhere('target_contact_id', '=', $clientID)
      ->addGroupBy('uf_match.uf_id')
      ->execute();
  }

  elseif ($clientID === 0 && preg_match('/[?&]aid=([^&]+)/', $path, $matches)) {
    $appointmentID = (int) $matches[1];
    $activities = \Civi\Api4\Activity::get(FALSE)
      ->addWhere('id', '=', $appointmentID)
      ->setLimit(1)
      ->execute();

    if(!count($activities)) {
      return TRUE;
    }
  }

  else {
    return TRUE;
  }
  $current_user_teams = _get_user_teams($current_user_id);
  \Drupal::logger('clin_client_profile')->info("Curr User: ".print_r($current_user_teams, TRUE));

  // Get user teams for each counsellor and current user
  foreach($activities as $activity) {  
    $assigned_staff_teams = _get_user_teams($activity['uf_match.uf_id']);

    \Drupal::logger('clin_client_profile')->info(print_r($assigned_staff_teams, TRUE));

    if (array_intersect($current_user_teams, $assigned_staff_teams)) {
      \Drupal::logger('clin_client_profile')->info("Access granted");
      return FALSE;
    }
  }
  \Drupal::logger('clin_client_profile')->info("Access denied");
  return TRUE;
}

function _get_user_teams($uid) {
  $teams = [];

  $userTeams = \Drupal::entityTypeManager()->getStorage('user')->load($uid)->get('field_user_team')->referencedEntities();
  foreach ($userTeams as $team) {
    $tid = $team->id();
    $teams[] = $tid;
 }
  return $teams;
}
