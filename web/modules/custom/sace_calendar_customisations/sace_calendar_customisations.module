<?php

use Drupal\views\ViewExecutable;
use Drupal\Core\Asset\AttachedAssetsInterface;

function sace_calendar_customisations_views_pre_render(ViewExecutable $view) {
  if ($view->id() === 'clin_calendar') {
    $view->element['#attached']['library'][] = 'sace_calendar_customisations/sace_calendar_customisations';
  }
  if ($view->id() === 'kg_duplicate_of_ped_booking_calendar') {
    $view->element['#attached']['library'][] = 'fontawesome/fontawesome.webfonts.solid';
  }
}

function sace_calendar_customisations_views_pre_execute(ViewExecutable $view) {
  if ($view->id() == 'kg_duplicate_of_ped_booking_calendar' || $view->id() == 'ped_update_online_booking' || $view->id() == 'duplicate_of_ped_booking_calendar') {
    $view->build_info['query']->groupby('civicrm_activity_contact3.id');
    $view->build_info['query']->groupby('civicrm_contact_civicrm_activity_contact.id');
  }
}

function sace_calendar_customisations_js_settings_alter(&$settings, AttachedAssetsInterface $assets) {
  if (isset($settings['fullCalendarView'])) {
    $settings['sace_calender_customisations']['fields'] = [
      'date' => 'edit-civicrm-1-activity-1-activity-activity-date-time-date',
      'time' => 'edit-civicrm-1-activity-1-activity-activity-date-time-time',
      'duration' => 'edit-civicrm-1-activity-1-activity-duration',
    ];
    if (\Drupal::request()->getPathInfo() === '/clin-update-appointment') {
      $settings['sace_calender_customisations']['fields'] = [
        'date' => 'edit-rescheduled-activity-date-date',
        'time' => 'edit-rescheduled-activity-date-time',
        'duration' => 'edit-recheduled-activity-duration',
      ];
    }
    foreach ($settings['fullCalendarView'] as $key => $setting) {
      $calender_view_settings = json_decode($setting['calendar_options'], TRUE);
      $calender_view_settings['editable'] = TRUE;
      $calender_view_settings['eventStartEditable'] = TRUE;
      $calender_view_settings['eventDurationEditable'] = TRUE;
      $calender_view_settings['selectable'] = TRUE;
      $calender_view_settings['selectHelper'] = TRUE;
      $calender_view_settings['selectMirror'] = TRUE;
      $calender_view_settings['slotDuration'] = '00:15:00';
      $calender_view_settings['slotLabelInterval'] = '01:00:00';
      $settings['fullCalendarView'][$key]['calendar_options'] = json_encode($calender_view_settings);
    }
  }
}
