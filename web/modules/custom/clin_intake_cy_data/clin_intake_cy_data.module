<?php

use Drupal\webform\Utility\WebformFormHelper;

@require_once 'clin_intake_cy_data.variables.php';

/**
 * Implements hook_form_alter().
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function clin_intake_cy_data_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if ($form_id == "webform_submission_clin_c_y_intake_data_add_form") {
    // Get custom field constants
    $constants = get_defined_constants(FALSE);

    //Attach library
    $form['#attached']['library'][] = 'clin_intake_cy_data/clin_intake_cy_data';

    $cid1 = \Drupal::request()->query->get('cid1') ?? 0;
    if (!empty($cid1) && is_numeric($cid1)) {
      \Drupal::service('civicrm')->initialize();
      // Get contact information
      $contact1 = \Civi\Api4\Contact::get(FALSE)
        ->addWhere('id', '=', $cid1)
        ->setLimit(1)
        ->execute()
        ->first();

      // Get webform form elements
      $elements = WebformFormHelper::flattenElements($form);
      if (!empty($elements)) {
        // Set default value for caller name field
        $elements[CLIN_INTAKE_CY_DATA_CALLER_NAME]['#default_value'] = $contact1['display_name'];
      }
    }

    $aid = \Drupal::request()->query->get('aid') ?? 0;
    if (!empty($aid) && is_numeric($aid)) {
      \Drupal::service('civicrm')->initialize();
      // Get booking type from activity
      $activityRef = \Civi\Api4\Activity::get(FALSE)
        ->addWhere('id', '=', $aid)
        ->setLimit(1)
        ->execute()
        ->first();

      // Get webform form elements
      $elements = WebformFormHelper::flattenElements($form);
      if (!empty($elements)) {
        // Set default values for initial call date and intake number
        $dateTime = new DateTime($activityRef['created_date']);
        $formattedDate = $dateTime->format('Y-m-d');

        $elements[CLIN_INTAKE_CY_DATA_INITIAL_CALL]['#default_value'] = $formattedDate;
        $elements[CLIN_INTAKE_CY_DATA_INTAKE_NUMBER]['#default_value'] = $aid;
      }
    }
  }
}

// function clin_intake_booking_update_preprocess_page_title(&$variables, $hook) {
//   $current_path = \Drupal::service('path.current')->getPath();
//   if ($current_path == '/webform/clin_intake_cy_data') {
//     //Activity ID
//     $aid = \Drupal::request()->query->get('aid') ?? 0;
//     if (empty($aid) || !is_numeric($aid)) {
//       return;
//     }

//     \Drupal::service('civicrm')->initialize();
//     //Get booking type from activity
//     $activity = \Civi\Api4\Activity::get(FALSE)
//       ->addSelect('activity_type_id')
//       ->addWhere('id', '=', $aid)
//       ->setLimit(1)
//       ->execute();
//     $bt = $activity->first()['activity_type_id'];
//   }
// }
